<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4"
      main_tree_to_execute="Main">
  <!-- ////////// -->
  <BehaviorTree ID="Main">
    <KeepRunningUntilFailure>
      <ForceSuccess>
        <Sequence>
          <SubTree ID="check_game_start"/>
          <Action ID="SetChassisMode"
                  mode="1"
                  topic_name="/chassis_mode"
                  current_mode_in="{@last_mode}"
                  current_mode="{last_mode}"
                  combat_cooldown_ready_time="{@combat_cooldown_ready_time}"/>
          <Action ID="PublishSpinSpeed"
                  spin_speed="7.0"
                  duration="200"
                  topic_name="cmd_spin"/>
          <ReactiveFallback name="mode_execution">
            <SubTree ID="ModeSelect"/>
            <Sequence name="execute_survival_mode">
              <ScriptCondition code="current_mode == 3"/>
              <SubTree ID="rmul_supply"/>
            </Sequence>
            <Sequence name="execute_combat_mode">
              <ScriptCondition code="current_mode == 2"/>
              <Sequence name="combat_actions">
                <Condition ID="CalculateAttackPose"
                           costmap_port="{nav_globalCostmap}"
                           tracker_port="{tracker_target}"
                           goal="{attack_pose}"
                           topic_name="debug_attack_pose"/>
                <Condition ID="PubNav2Goal"
                           goal="{attack_pose}"
                           topic_name="goal_pose"/>
              </Sequence>
            </Sequence>
            <Sequence name="execute_default_mode">
              <ScriptCondition code="current_mode == 1"/>
              <Decorator ID="RateController"
                         hz="5.0">
                <Sequence>
                  <SubTree ID="check_robot_status"/>
                  <Condition ID="PubNav2Goal"
                             goal="4.65;-3.5;0"
                             topic_name="goal_pose"/>
                </Sequence>
              </Decorator>
            </Sequence>
          </ReactiveFallback>
        </Sequence>
      </ForceSuccess>
    </KeepRunningUntilFailure>
  </BehaviorTree>

  <!-- ////////// -->
  <BehaviorTree ID="ModeSelect">
    <ReactiveFallback name="brain_decision_system">
      <Sequence name="survival_mode">
        <Fallback name="check_survival_condition">
          <Inverter>
            <Condition ID="IsStatusOK"
                       ammo_min="0"
                       heat_max="350"
                       hp_min="120"
                       key_port="{@referee_robotStatus}"/>
          </Inverter>
          <Sequence name="maintain_survival">
            <ScriptCondition code="last_mode == 3"/>
            <Inverter>
              <Condition ID="IsStatusOK"
                         ammo_min="0"
                         heat_max="350"
                         hp_min="300"
                         key_port="{@referee_robotStatus}"/>
            </Inverter>
          </Sequence>
        </Fallback>
        <Fallback>
          <ScriptCondition code="current_node == 3"/>
          <Action ID="SetChassisMode"
                  mode="3"
                  topic_name="/chassis_mode"
                  current_mode_in="{@last_mode}"
                  current_mode="{last_mode}"
                  combat_cooldown_ready_time="{@combat_cooldown_ready_time}"/>
        </Fallback>
        <ReactiveFallback name="survival_sub_behaviors">
          <Sequence name="path_blocked_logic">
            <Condition ID="IsPathBlocked"
                       key_port="{@nav_path_status}"/>
            <Action ID="HandlePathBlocked"
                    key_port="{@nav_path_status}"/>
          </Sequence>
          <Sequence name="path_clear_logic">
            <Condition ID="IsPathClear"
                       key_port="{@nav_path_status}"/>
            <Action ID="HandlePathClear"
                    key_port="{@nav_path_status}"/>
          </Sequence>
          <AlwaysSuccess/>
        </ReactiveFallback>
      </Sequence>
      <Sequence name="combat_mode">
        <Condition ID="IsDetectEnemy"
                   armor_id="1;2;3;4;5;7"
                   max_distance="8.0"
                   key_port="{@detector_armors}"/>
        <Fallback>
          <ScriptCondition code="current_node == 2"/>
          <Action ID="SetChassisMode"
                  mode="2"
                  topic_name="/chassis_mode"
                  current_mode_in="{@last_mode}"
                  current_mode="{last_mode}"
                  combat_cooldown_ready_time="{@combat_cooldown_ready_time}"/>
        </Fallback>
      </Sequence>
      <Fallback>
        <ScriptCondition code="current_node == 1"/>
        <Sequence name="default_mode_entry">
          <Fallback name="combat_cooldown_gate">
            <ScriptCondition code="last_mode != 2"/>
            <Condition ID="IsCombatCooldownReady"
                       ready_time="{@combat_cooldown_ready_time}"/>
          </Fallback>
          <Action ID="SetChassisMode"
                  mode="1"
                  topic_name="/chassis_mode"
                  current_mode_in="{@last_mode}"
                  current_mode="{last_mode}"
                  combat_cooldown_ready_time="{@combat_cooldown_ready_time}"/>
        </Sequence>
      </Fallback>
    </ReactiveFallback>
  </BehaviorTree>

  <!-- ////////// -->
  <BehaviorTree ID="check_game_start">
    <Fallback>
      <Condition ID="IsGameStatus"
                 name="IsGameStart"
                 max_remain_time="420"
                 min_remain_time="0"
                 expected_game_progress="4"
                 key_port="{@referee_gameStatus}"/>
      <AlwaysSuccess/>
    </Fallback>
  </BehaviorTree>

  <!-- ////////// -->
  <BehaviorTree ID="check_robot_status">
    <Condition ID="IsStatusOK"
               ammo_min="0"
               heat_max="350"
               hp_min="300"
               key_port="{@referee_robotStatus}"/>
  </BehaviorTree>

  <!-- ////////// -->
  <BehaviorTree ID="rmul_supply">
    <WhileDoElse>
      <Condition ID="IsRfidDetected"
                 friendly_supply_zone_exchange="false"
                 friendly_supply_zone_non_exchange="true"
                 center_gain_point="false"
                 friendly_fortress_gain_point="false"
                 key_port="{@referee_rfidStatus}"/>
      <RetryUntilSuccessful num_attempts="-1">
        <Condition ID="IsStatusOK"
                   ammo_min="0"
                   heat_max="100"
                   hp_min="399"
                   key_port="{@referee_robotStatus}"/>
      </RetryUntilSuccessful>
      <Sequence>
        <Condition ID="PubNav2Goal"
                   goal="0;0;0"
                   topic_name="goal_pose"/>
      </Sequence>
    </WhileDoElse>
  </BehaviorTree>

  <!-- ////////// -->
  <BehaviorTree ID="supply_monitor">
    <WhileDoElse>
      <Inverter>
        <Condition ID="IsStatusOK"
                   ammo_min="0"
                   heat_max="350"
                   hp_min="200"
                   key_port="{@referee_robotStatus}"/>
      </Inverter>
      <SubTree ID="rmul_supply"/>
      <AlwaysSuccess/>
    </WhileDoElse>
  </BehaviorTree>

  <!-- ////////// -->
  <BehaviorTree ID="test_attack_pose">
    <KeepRunningUntilFailure>
      <ForceSuccess>
        <Sequence>
          <Condition ID="CalculateAttackPose"
                     costmap_port="{@nav_globalCostmap}"
                     tracker_port="{@tracker_target}"
                     goal="{attack_pose}"
                     topic_name="debug_attack_pose"/>
          <Condition ID="PubNav2Goal"
                     goal="{attack_pose}"
                     topic_name="goal_pose"/>
        </Sequence>
      </ForceSuccess>
    </KeepRunningUntilFailure>
  </BehaviorTree>

  <!-- ////////// -->
  <BehaviorTree ID="test_attacked_feedback">
    <KeepRunningUntilFailure>
      <WhileDoElse>
        <Condition ID="IsAttacked"
                   gimbal_yaw="{gimbal_yaw}"
                   gimbal_pitch="{gimbal_pitch}"
                   key_port="{@referee_robotStatus}"/>
        <Sequence>
          <Action ID="PublishGimbalAbsolute"
                  topic_name="cmd_gimbal"
                  duration="500"
                  gimbal_yaw="{gimbal_yaw}"
                  gimbal_pitch="{gimbal_pitch}"/>
          <Action ID="PublishTwist"
                  v_y="0.0"
                  v_yaw="3.14"
                  v_x="0.0"
                  duration="2000"
                  topic_name="cmd_vel"/>
          <Action ID="PublishTwist"
                  v_y="0.0"
                  v_yaw="0.0"
                  v_x="1.0"
                  duration="1000"
                  topic_name="cmd_vel"/>
          <Action ID="PublishTwist"
                  v_y="0.0"
                  v_yaw="3.14"
                  v_x="1.0"
                  duration="1000"
                  topic_name="cmd_vel"/>
        </Sequence>
        <AlwaysSuccess/>
      </WhileDoElse>
    </KeepRunningUntilFailure>
  </BehaviorTree>

  <!-- ////////// -->
  <BehaviorTree ID="test_gimbal_absolute">
    <Action ID="PublishGimbalAbsolute"
            topic_name="cmd_gimbal"
            duration="5000"
            gimbal_yaw="-1.57"
            gimbal_pitch="1.0"/>
  </BehaviorTree>

  <!-- ////////// -->
  <BehaviorTree ID="test_gimbal_velocity">
    <Action ID="PublishGimbalVelocity"
            duration="5000"
            yaw_min="-1.57"
            pitch_min="-0.3"
            yaw_max="1.57"
            pitch_max="0.3"
            gimbal_vel_yaw="1.5"
            topic_name="cmd_gimbal"
            gimbal_vel_pitch="1.0"/>
  </BehaviorTree>

  <!-- ////////// -->
  <BehaviorTree ID="test_go_to_supply">
    <Repeat num_cycles="-1">
      <WhileDoElse>
        <Condition ID="IsStatusOK"
                   ammo_min="0"
                   heat_max="350"
                   hp_min="350"
                   key_port="{@referee_robotStatus}"/>
        <Sequence>
          <Condition ID="PubNav2Goal"
                     goal="{goal}"
                     topic_name="/goal_pose"/>
        </Sequence>
        <SubTree ID="rmul_supply"/>
      </WhileDoElse>
    </Repeat>
  </BehaviorTree>

  <!-- ////////// -->
  <BehaviorTree ID="test_is_detect_enemy">
    <ReactiveFallback>
      <Inverter>
        <Condition ID="IsDetectEnemy"
                   armor_id="1;2;3;4;5;7"
                   max_distance="8.0"
                   key_port="{@detector_armors}"/>
      </Inverter>
      <Action ID="PublishTwist"
              v_y="0.0"
              v_yaw="6.28"
              v_x="0.0"
              duration="3000"
              topic_name="cmd_vel"/>
    </ReactiveFallback>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Condition ID="CalculateAttackPose">
      <input_port name="costmap_port"
                  default="{nav_globalCostmap}"
                  type="nav_msgs::msg::OccupancyGrid_&lt;std::allocator&lt;void&gt; &gt;"/>
      <input_port name="tracker_port"
                  default="{tracker_target}"
                  type="auto_aim_interfaces::msg::Target_&lt;std::allocator&lt;void&gt; &gt;"/>
      <output_port name="goal"
                   default="{attack_pose}"
                   type="geometry_msgs::msg::PoseStamped_&lt;std::allocator&lt;void&gt; &gt;"/>
      <input_port name="topic_name"
                  default="__default__placeholder__"
                  type="std::string"/>
    </Condition>
    <Action ID="HandlePathBlocked">
      <input_port name="key_port"
                  default="{@nav_path_status}"
                  type="auto">Placeholder action to handle blocked path (implement logic in plugin)</input_port>
    </Action>
    <Action ID="HandlePathClear">
      <input_port name="key_port"
                  default="{@nav_path_status}"
                  type="auto">Placeholder action to handle cleared path (implement logic in plugin)</input_port>
    </Action>
    <Condition ID="IsAttacked">
      <output_port name="gimbal_yaw"
                   default="{gimbal_yaw}"
                   type="float"/>
      <output_port name="gimbal_pitch"
                   default="{gimbal_pitch}"
                   type="float"/>
      <input_port name="key_port"
                  default="{referee_robotStatus}"
                  type="pb_rm_interfaces::msg::RobotStatus_&lt;std::allocator&lt;void&gt; &gt;"/>
    </Condition>
    <Condition ID="IsCombatCooldownReady">
      <input_port name="ready_time"
                  default="{@combat_cooldown_ready_time}"
                  type="double">Timestamp threshold from SetChassisMode (mode 2 adds 3s). Returns SUCCESS once the current steady-clock time &gt;= ready_time.</input_port>
    </Condition>
    <Condition ID="IsDetectEnemy">
      <input_port name="armor_id"
                  default="1;2;3;4;5;7"
                  type="std::vector&lt;int, std::allocator&lt;int&gt; &gt;">Expected id of armors</input_port>
      <input_port name="max_distance"
                  default="8.0"
                  type="float">Distance to enemy target</input_port>
      <input_port name="key_port"
                  default="{@detector_armors}"
                  type="auto_aim_interfaces::msg::Armors_&lt;std::allocator&lt;void&gt; &gt;">Vision detector port</input_port>
    </Condition>
    <Condition ID="IsGameStatus">
      <input_port name="max_remain_time"
                  default="420"
                  type="int"/>
      <input_port name="min_remain_time"
                  default="0"
                  type="int"/>
      <input_port name="expected_game_progress"
                  default="4"
                  type="int"/>
      <input_port name="key_port"
                  default="{referee_gameStatus}"
                  type="pb_rm_interfaces::msg::GameStatus_&lt;std::allocator&lt;void&gt; &gt;"/>
    </Condition>
    <Condition ID="IsPathBlocked">
      <input_port name="key_port"
                  default="{@nav_path_status}"
                  type="auto">Navigation path status blackboard key (expected structure defined by nav module)</input_port>
    </Condition>
    <Condition ID="IsPathClear">
      <input_port name="key_port"
                  default="{@nav_path_status}"
                  type="auto">Navigation path status blackboard key (inverse of IsPathBlocked)</input_port>
    </Condition>
    <Condition ID="IsRfidDetected">
      <input_port name="friendly_supply_zone_exchange"
                  default="false"
                  type="bool"/>
      <input_port name="friendly_supply_zone_non_exchange"
                  default="false"
                  type="bool"/>
      <input_port name="center_gain_point"
                  default="false"
                  type="bool"/>
      <input_port name="friendly_fortress_gain_point"
                  default="false"
                  type="bool"/>
      <input_port name="key_port"
                  default="{referee_rfidStatus}"
                  type="pb_rm_interfaces::msg::RfidStatus_&lt;std::allocator&lt;void&gt; &gt;"/>
    </Condition>
    <Condition ID="IsStatusOK">
      <input_port name="ammo_min"
                  default="0"
                  type="int">Lower then minimum ammo will return FAILURE</input_port>
      <input_port name="heat_max"
                  default="350"
                  type="int">Maximum heat</input_port>
      <input_port name="hp_min"
                  default="300"
                  type="int">Minimum HP</input_port>
      <input_port name="key_port"
                  default="{@referee_robotStatus}"
                  type="pb_rm_interfaces::msg::RobotStatus_&lt;std::allocator&lt;void&gt; &gt;">RobotStatus port</input_port>
    </Condition>
    <Condition ID="PubNav2Goal">
      <input_port name="goal"
                  default="0;0;0"
                  type="geometry_msgs::msg::PoseStamped_&lt;std::allocator&lt;void&gt; &gt;"/>
      <input_port name="topic_name"
                  default="__default__placeholder__"
                  type="std::string"/>
    </Condition>
    <Action ID="PublishGimbalAbsolute">
      <input_port name="topic_name"
                  default="__default__placeholder__"
                  type="std::string"/>
      <input_port name="duration"
                  type="std::chrono::milliseconds"/>
      <input_port name="gimbal_yaw"
                  type="float"/>
      <input_port name="gimbal_pitch"
                  type="float"/>
    </Action>
    <Action ID="PublishGimbalVelocity">
      <input_port name="duration"
                  type="std::chrono::milliseconds"/>
      <input_port name="yaw_min"
                  default="-3.140000"
                  type="float"/>
      <input_port name="pitch_min"
                  default="-1.570000"
                  type="float"/>
      <input_port name="yaw_max"
                  default="3.140000"
                  type="float"/>
      <input_port name="pitch_max"
                  default="1.570000"
                  type="float"/>
      <input_port name="gimbal_vel_yaw"
                  default="0.000000"
                  type="float"/>
      <input_port name="topic_name"
                  default="__default__placeholder__"
                  type="std::string"/>
      <input_port name="gimbal_vel_pitch"
                  default="0.000000"
                  type="float"/>
    </Action>
    <Action ID="PublishSpinSpeed">
      <input_port name="spin_speed"
                  default="0.000000"
                  type="double"/>
      <input_port name="duration"
                  type="std::chrono::milliseconds"/>
      <input_port name="topic_name"
                  default="__default__placeholder__"
                  type="std::string"/>
    </Action>
    <Action ID="PublishTwist">
      <input_port name="v_y"
                  default="0.000000"
                  type="double"/>
      <input_port name="v_yaw"
                  default="0.000000"
                  type="double"/>
      <input_port name="v_x"
                  default="0.000000"
                  type="double"/>
      <input_port name="duration"
                  type="std::chrono::milliseconds"/>
      <input_port name="topic_name"
                  default="__default__placeholder__"
                  type="std::string"/>
    </Action>
    <Decorator ID="RateController">
      <input_port name="hz"
                  default="10.000000"
                  type="double"/>
    </Decorator>
    <Action ID="SetChassisMode">
      <input_port name="mode"
                  default="1"
                  type="int">Chassis Mode: 1=Follow, 2=Spin, 3=Survival</input_port>
      <input_port name="topic_name"
                  default="/chassis_mode"
                  type="std::string">ROS2 topic to publish the chassis mode (message type: std_msgs/msg/Int32)</input_port>
      <input_port name="current_mode_in"
                  default="{@last_mode}"
                  type="int">Optional read-only mapping to the blackboard key holding the last chassis mode (use {@last_mode}); lets the node skip redundant writes.</input_port>
      <output_port name="current_mode"
                   default="1"
                   type="int">Current chassis mode written when changed. Map this output to a blackboard key (e.g. {@last_mode}) to allow ScriptCondition and other nodes to read the current mode.</output_port>
      <output_port name="combat_cooldown_ready_time"
                   default="0.0"
                   type="double">Timestamp (steady clock seconds) stored whenever mode changes. When mode=2, the node pushes now+3s to enforce a cooldown before returning to mode 1.</output_port>
    </Action>
  </TreeNodesModel>

</root>
