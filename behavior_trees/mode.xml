<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4">
  <!-- ////////// -->
  <BehaviorTree ID="MainTree">
    <Sequence name="root_sequence">
      <RunOnce name="init_blackboard"
               then_skip="true">
        <Action ID="SetChassisMode"
                mode="1"
                topic_name="/chassis_mode"
                current_mode_in="{@last_mode}"
                current_mode="{last_mode}"
                combat_cooldown_ready_time="{@combat_cooldown_ready_time}"/>
      </RunOnce>
      <Decorator ID="TickAfterTimeout"
                 timeout="0.5">
        <ReactiveFallback name="brain_decision_system">
          <Sequence name="survival_mode">
            <Fallback name="check_survival_condition">
              <Inverter>
                <Condition ID="IsStatusOK"
                           ammo_min="0"
                           heat_max="350"
                           hp_min="120"
                           key_port="{@referee_robotStatus}"/>
              </Inverter>
              <Sequence name="maintain_survival">
                <ScriptCondition code="last_mode == 3"/>
                <Inverter>
                  <Condition ID="IsStatusOK"
                             ammo_min="0"
                             heat_max="350"
                             hp_min="300"
                             key_port="{@referee_robotStatus}"/>
                </Inverter>
              </Sequence>
            </Fallback>
            <Fallback>
              <ScriptCondition code="current_node == 3"/>
              <Action ID="SetChassisMode"
                      mode="3"
                      topic_name="/chassis_mode"
                      current_mode_in="{@last_mode}"
                      current_mode="{last_mode}"
                      combat_cooldown_ready_time="{@combat_cooldown_ready_time}"/>
            </Fallback>
            <ReactiveFallback name="survival_sub_behaviors">
              <Sequence name="path_blocked_logic">
                <Condition ID="IsPathBlocked"
                           key_port="{@nav_path_status}"/>
                <Action ID="HandlePathBlocked"
                        key_port="{@nav_path_status}"/>
              </Sequence>
              <Sequence name="path_clear_logic">
                <Condition ID="IsPathClear"
                           key_port="{@nav_path_status}"/>
                <Action ID="HandlePathClear"
                        key_port="{@nav_path_status}"/>
              </Sequence>
              <AlwaysSuccess/>
            </ReactiveFallback>
          </Sequence>
          <Sequence name="combat_mode">
            <Condition ID="IsDetectEnemy"
                       armor_id="1;2;3;4;5;7"
                       max_distance="8.0"
                       key_port="{@detector_armors}"/>
            <Fallback>
              <ScriptCondition code="current_node == 2"/>
              <Action ID="SetChassisMode"
                      mode="2"
                      topic_name="/chassis_mode"
                      current_mode_in="{@last_mode}"
                      current_mode="{last_mode}"
                      combat_cooldown_ready_time="{@combat_cooldown_ready_time}"/>
            </Fallback>
          </Sequence>
          <Fallback>
            <ScriptCondition code="current_node == 1"/>
            <Sequence name="default_mode_entry">
              <Fallback name="combat_cooldown_gate">
                <ScriptCondition code="last_mode != 2"/>
                <Condition ID="IsCombatCooldownReady"
                           ready_time="{@combat_cooldown_ready_time}"/>
              </Fallback>
              <Action ID="SetChassisMode"
                      mode="1"
                      topic_name="/chassis_mode"
                      current_mode_in="{@last_mode}"
                      current_mode="{last_mode}"
                      combat_cooldown_ready_time="{@combat_cooldown_ready_time}"/>
            </Sequence>
          </Fallback>
        </ReactiveFallback>
      </Decorator>
    </Sequence>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Action ID="HandlePathBlocked">
      <input_port name="key_port"
                  default="{@nav_path_status}"
                  type="auto">Placeholder action to handle blocked path (implement logic in plugin)</input_port>
    </Action>
    <Action ID="HandlePathClear">
      <input_port name="key_port"
                  default="{@nav_path_status}"
                  type="auto">Placeholder action to handle cleared path (implement logic in plugin)</input_port>
    </Action>
    <Condition ID="IsCombatCooldownReady">
      <input_port name="ready_time"
                  default="{@combat_cooldown_ready_time}"
                  type="double">Timestamp threshold from SetChassisMode (mode 2 adds 3s). Returns SUCCESS once the current steady-clock time &gt;= ready_time.</input_port>
    </Condition>
    <Condition ID="IsDetectEnemy">
      <input_port name="armor_id"
                  default="1;2;3;4;5;7"
                  type="std::vector&lt;int, std::allocator&lt;int&gt; &gt;">Expected id of armors</input_port>
      <input_port name="max_distance"
                  default="8.0"
                  type="float">Distance to enemy target</input_port>
      <input_port name="key_port"
                  default="{@detector_armors}"
                  type="auto_aim_interfaces::msg::Armors_&lt;std::allocator&lt;void&gt; &gt;">Vision detector port</input_port>
    </Condition>
    <Condition ID="IsPathBlocked">
      <input_port name="key_port"
                  default="{@nav_path_status}"
                  type="auto">Navigation path status blackboard key (expected structure defined by nav module)</input_port>
    </Condition>
    <Condition ID="IsPathClear">
      <input_port name="key_port"
                  default="{@nav_path_status}"
                  type="auto">Navigation path status blackboard key (inverse of IsPathBlocked)</input_port>
    </Condition>
    <Condition ID="IsStatusOK">
      <input_port name="ammo_min"
                  default="0"
                  type="int">Lower then minimum ammo will return FAILURE</input_port>
      <input_port name="heat_max"
                  default="350"
                  type="int">Maximum heat</input_port>
      <input_port name="hp_min"
                  default="300"
                  type="int">Minimum HP</input_port>
      <input_port name="key_port"
                  default="{@referee_robotStatus}"
                  type="pb_rm_interfaces::msg::RobotStatus_&lt;std::allocator&lt;void&gt; &gt;">RobotStatus port</input_port>
    </Condition>
    <Action ID="SetChassisMode">
      <input_port name="mode"
                  default="1"
                  type="int">Chassis Mode: 1=Follow, 2=Spin, 3=Survival</input_port>
      <input_port name="topic_name"
                  default="/chassis_mode"
                  type="std::string">ROS2 topic to publish the chassis mode (message type: std_msgs/msg/Int32)</input_port>
      <input_port name="current_mode_in"
                  default="{@last_mode}"
                  type="int">Optional read-only mapping to the blackboard key holding the last chassis mode (use {@last_mode}); lets the node skip redundant writes.</input_port>
      <output_port name="current_mode"
                   default="1"
                   type="int">Current chassis mode written when changed. Map this output to a blackboard key (e.g. {@last_mode}) to allow ScriptCondition and other nodes to read the current mode.</output_port>
      <output_port name="combat_cooldown_ready_time"
                   default="0.0"
                   type="double">Timestamp (steady clock seconds) stored whenever mode changes. When mode=2, the node pushes now+3s to enforce a cooldown before returning to mode 1.</output_port>
    </Action>
    <Decorator ID="TickAfterTimeout">
      <input_port name="timeout"
                  type="float">time in seconds to wait before ticking child again</input_port>
    </Decorator>
  </TreeNodesModel>

</root>
